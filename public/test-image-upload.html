<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload Test - SaaS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">
            <i class="fas fa-upload mr-2 text-blue-500"></i>
            Image Upload Test - SaaS System
        </h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Upload Test Results</h2>
            <div id="testResults" class="space-y-4">
                <!-- Test results will be populated here -->
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Direct Cloudinary Upload Test -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold mb-4">
                    <i class="fas fa-cloud mr-2 text-green-500"></i>
                    Direct Cloudinary Upload
                </h3>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">Test direct Cloudinary upload</p>
                    <input type="file" id="directUpload" accept="image/*" class="hidden">
                    <button id="directUploadBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-upload mr-2"></i>Upload Direct
                    </button>
                </div>
                <div id="directResult" class="mt-4 hidden">
                    <img id="directImage" class="w-full h-48 object-cover rounded-lg mb-2">
                    <p id="directInfo" class="text-sm text-gray-600"></p>
                </div>
            </div>

            <!-- SaaS Service Upload Test -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold mb-4">
                    <i class="fas fa-server mr-2 text-blue-500"></i>
                    SaaS Service Upload
                </h3>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <i class="fas fa-server text-3xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">Test SaaS service upload</p>
                    <input type="file" id="saasUpload" accept="image/*" class="hidden">
                    <button id="saasUploadBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-upload mr-2"></i>Upload via SaaS
                    </button>
                </div>
                <div id="saasResult" class="mt-4 hidden">
                    <img id="saasImage" class="w-full h-48 object-cover rounded-lg mb-2">
                    <p id="saasInfo" class="text-sm text-gray-600"></p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-info-circle mr-2 text-yellow-500"></i>
                Upload Configuration Status
            </h3>
            <div id="configStatus" class="space-y-2">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i>
                    <span>Checking configuration...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Load SaaS Service -->
    <script src="js/saas-case-study-service.js"></script>
    
    <script>
        class ImageUploadTester {
            constructor() {
                this.init();
            }

            async init() {
                console.log('ðŸ§ª Initializing Image Upload Tester...');
                
                this.setupEventListeners();
                await this.checkConfiguration();
                
                console.log('âœ… Image Upload Tester ready!');
            }

            setupEventListeners() {
                // Direct upload
                document.getElementById('directUploadBtn').addEventListener('click', () => {
                    document.getElementById('directUpload').click();
                });

                document.getElementById('directUpload').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.testDirectUpload(e.target.files[0]);
                    }
                });

                // SaaS upload
                document.getElementById('saasUploadBtn').addEventListener('click', () => {
                    document.getElementById('saasUpload').click();
                });

                document.getElementById('saasUpload').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.testSaaSUpload(e.target.files[0]);
                    }
                });
            }

            async checkConfiguration() {
                const statusContainer = document.getElementById('configStatus');
                const checks = [];

                // Check Cloudinary configuration
                try {
                    const cloudinaryTest = await fetch('https://api.cloudinary.com/v1_1/dgymjtqil/image/list', {
                        method: 'GET'
                    });
                    
                    checks.push({
                        name: 'Cloudinary API Access',
                        status: cloudinaryTest.status === 200 || cloudinaryTest.status === 401 ? 'success' : 'error',
                        message: cloudinaryTest.status === 200 || cloudinaryTest.status === 401 ? 'Cloudinary API accessible' : 'Cloudinary API not accessible'
                    });
                } catch (error) {
                    checks.push({
                        name: 'Cloudinary API Access',
                        status: 'error',
                        message: 'Cloudinary API connection failed'
                    });
                }

                // Check SaaS service
                try {
                    const saasTest = await fetch('/health');
                    checks.push({
                        name: 'SaaS Server',
                        status: saasTest.ok ? 'success' : 'error',
                        message: saasTest.ok ? 'SaaS server running' : 'SaaS server not available'
                    });
                } catch (error) {
                    checks.push({
                        name: 'SaaS Server',
                        status: 'error',
                        message: 'SaaS server not running'
                    });
                }

                // Check authentication
                const isAuthenticated = window.saasService && window.saasService.isAuthenticated();
                checks.push({
                    name: 'Authentication',
                    status: isAuthenticated ? 'success' : 'warning',
                    message: isAuthenticated ? 'User authenticated' : 'Not authenticated (will use fallback)'
                });

                // Display results
                statusContainer.innerHTML = checks.map(check => `
                    <div class="flex items-center">
                        <i class="fas ${this.getStatusIcon(check.status)} ${this.getStatusColor(check.status)} mr-2"></i>
                        <span class="font-medium">${check.name}:</span>
                        <span class="ml-2 text-gray-600">${check.message}</span>
                    </div>
                `).join('');
            }

            async testDirectUpload(file) {
                const resultDiv = document.getElementById('directResult');
                const imageEl = document.getElementById('directImage');
                const infoEl = document.getElementById('directInfo');

                try {
                    this.addTestResult('Direct Upload', 'testing', 'Testing direct Cloudinary upload...');

                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', 'ml_default');
                    formData.append('api_key', '951533987774134');
                    formData.append('folder', 'portfolio/test');

                    const response = await fetch('https://api.cloudinary.com/v1_1/dgymjtqil/image/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    // Display result
                    imageEl.src = result.secure_url;
                    infoEl.textContent = `Size: ${Math.round(result.bytes / 1024)}KB | Dimensions: ${result.width}x${result.height}`;
                    resultDiv.classList.remove('hidden');

                    this.addTestResult('Direct Upload', 'success', `Successfully uploaded: ${result.secure_url}`);

                } catch (error) {
                    console.error('Direct upload error:', error);
                    this.addTestResult('Direct Upload', 'error', `Failed: ${error.message}`);
                }
            }

            async testSaaSUpload(file) {
                const resultDiv = document.getElementById('saasResult');
                const imageEl = document.getElementById('saasImage');
                const infoEl = document.getElementById('saasInfo');

                try {
                    this.addTestResult('SaaS Upload', 'testing', 'Testing SaaS service upload...');

                    const response = await window.saasService.uploadImage(file, {
                        folder: 'test',
                        optimize: true
                    });

                    // Display result
                    imageEl.src = response.data.url;
                    infoEl.textContent = `Size: ${Math.round(response.data.size / 1024)}KB | Dimensions: ${response.data.width}x${response.data.height}`;
                    resultDiv.classList.remove('hidden');

                    this.addTestResult('SaaS Upload', 'success', `Successfully uploaded via SaaS: ${response.data.url}`);

                } catch (error) {
                    console.error('SaaS upload error:', error);
                    this.addTestResult('SaaS Upload', 'error', `Failed: ${error.message}`);
                }
            }

            addTestResult(testName, status, message) {
                const container = document.getElementById('testResults');
                const resultDiv = document.createElement('div');
                resultDiv.className = `p-4 rounded-lg border ${this.getStatusBg(status)}`;
                resultDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${this.getStatusIcon(status)} ${this.getStatusColor(status)} mr-3"></i>
                        <div>
                            <h4 class="font-semibold">${testName}</h4>
                            <p class="text-sm text-gray-600">${message}</p>
                            <p class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</p>
                        </div>
                    </div>
                `;
                container.appendChild(resultDiv);
            }

            getStatusIcon(status) {
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    testing: 'fa-spinner fa-spin'
                };
                return icons[status] || 'fa-info-circle';
            }

            getStatusColor(status) {
                const colors = {
                    success: 'text-green-500',
                    error: 'text-red-500',
                    warning: 'text-yellow-500',
                    testing: 'text-blue-500'
                };
                return colors[status] || 'text-gray-500';
            }

            getStatusBg(status) {
                const backgrounds = {
                    success: 'bg-green-50 border-green-200',
                    error: 'bg-red-50 border-red-200',
                    warning: 'bg-yellow-50 border-yellow-200',
                    testing: 'bg-blue-50 border-blue-200'
                };
                return backgrounds[status] || 'bg-gray-50 border-gray-200';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.uploadTester = new ImageUploadTester();
        });
    </script>
</body>
</html>